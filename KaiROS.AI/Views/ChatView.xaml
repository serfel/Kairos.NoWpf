<UserControl x:Class="KaiROS.AI.Views.ChatView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:KaiROS.AI.ViewModels"
             xmlns:converters="clr-namespace:KaiROS.AI.Converters">
    
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
    </UserControl.Resources>
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- Session Sidebar -->
        <Border Background="{StaticResource CardBrush}"
                CornerRadius="12"
                Margin="0,0,16,0"
                Padding="12"
                Width="220"
                Visibility="{Binding IsSessionListVisible, Converter={StaticResource BoolToVis}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- New Chat Button -->
                <Button Command="{Binding NewSessionCommand}"
                        Style="{StaticResource AccentButton}"
                        Margin="0,0,0,12">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="âž•" Margin="0,0,8,0"/>
                        <TextBlock Text="New Chat"/>
                    </StackPanel>
                </Button>
                
                <!-- Session List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Sessions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource SurfaceLightBrush}"
                                        CornerRadius="8"
                                        Padding="12,10"
                                        Margin="0,0,0,8"
                                        Cursor="Hand">
                                    <Border.InputBindings>
                                        <MouseBinding MouseAction="LeftClick" 
                                                      Command="{Binding DataContext.LoadSessionCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                      CommandParameter="{Binding}"/>
                                    </Border.InputBindings>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Text="{Binding Title}" 
                                                       Foreground="{StaticResource TextPrimaryBrush}"
                                                       TextTrimming="CharacterEllipsis"
                                                       FontWeight="Medium"/>
                                            <TextBlock Foreground="{StaticResource TextMutedBrush}" 
                                                       FontSize="11"
                                                       Margin="0,4,0,0">
                                                <Run Text="{Binding MessageCount, Mode=OneWay}"/>
                                                <Run Text="messages â€¢"/>
                                                <Run Text="{Binding UpdatedAt, StringFormat='{}{0:MMM d}', Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>
                                        <Button Grid.Column="1" 
                                                Content="ðŸ—‘" 
                                                Style="{StaticResource IconButton}"
                                                Command="{Binding DataContext.DeleteSessionCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}"
                                                VerticalAlignment="Center"
                                                Opacity="0.6"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
                
                <!-- Empty State -->
                <TextBlock Grid.Row="1"
                           Text="No chat history yet"
                           Foreground="{StaticResource TextMutedBrush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="{Binding Sessions.Count, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}"/>
            </Grid>
        </Border>
        
        <!-- Main Chat Area -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
        
        <!-- Header with Model Info -->
        <Border Background="{StaticResource CardBrush}" 
                CornerRadius="12" 
                Padding="16"
                Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel>
                    <TextBlock Text="Chat" 
                               FontSize="24" 
                               FontWeight="Bold" 
                               Foreground="{StaticResource TextPrimaryBrush}"/>
                    <TextBlock Text="{Binding ActiveModelInfo}" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,4,0,0"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="ðŸ—‘ Clear" 
                            Command="{Binding ClearChatCommand}"
                            Style="{StaticResource SecondaryButton}"
                            Margin="0,0,8,0"/>
                    <Button Content="ðŸ“¤ Export" 
                            Command="{Binding ExportChatCommand}"
                            Style="{StaticResource SecondaryButton}"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Messages -->
        <ScrollViewer Grid.Row="1" 
                      x:Name="MessagesScroller"
                      VerticalScrollBarVisibility="Auto"
                      Margin="0,0,0,16">
            <ItemsControl ItemsSource="{Binding Messages}" x:Name="MessagesList">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:ChatMessageViewModel}">
                        <Grid Margin="0,0,0,12">
                            <!-- User Message -->
                            <Border HorizontalAlignment="Right"
                                    MaxWidth="600"
                                    Visibility="{Binding IsUser, Converter={StaticResource BoolToVis}}">
                                <Border Background="{StaticResource PrimaryBrush}" 
                                        CornerRadius="16,16,4,16" 
                                        Padding="16,12">
                                    <StackPanel>
                                        <TextBlock Text="{Binding Content}" 
                                                   Foreground="White"
                                                   TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Timestamp}" 
                                                   Foreground="#FFFFFF80"
                                                   FontSize="11"
                                                   HorizontalAlignment="Right"
                                                   Margin="0,8,0,0"/>
                                    </StackPanel>
                                </Border>
                            </Border>
                            
                            <!-- Assistant Message -->
                            <Border HorizontalAlignment="Left"
                                    MaxWidth="600"
                                    Visibility="{Binding IsAssistant, Converter={StaticResource BoolToVis}}">
                                <Border Background="{StaticResource SurfaceLightBrush}" 
                                        CornerRadius="16,16,16,4" 
                                        Padding="16,12">
                                    <StackPanel>
                                        <TextBlock Text="ðŸ¤– Assistant" 
                                                   Foreground="{StaticResource PrimaryLightBrush}"
                                                   FontSize="12"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,8"/>
                                        <TextBlock Text="{Binding Content}" 
                                                   Foreground="{StaticResource TextPrimaryBrush}"
                                                   TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Timestamp}" 
                                                   Foreground="{StaticResource TextMutedBrush}"
                                                   FontSize="11"
                                                   HorizontalAlignment="Right"
                                                   Margin="0,8,0,0"/>
                                        
                                        <!-- Streaming Indicator -->
                                        <TextBlock Text="â—â—â—" 
                                                   Foreground="{StaticResource PrimaryBrush}"
                                                   FontSize="14"
                                                   Margin="0,4,0,0"
                                                   Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVis}}">
                                            <TextBlock.Triggers>
                                                <EventTrigger RoutedEvent="Loaded">
                                                    <BeginStoryboard>
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1" Duration="0:0:0.5"
                                                                             AutoReverse="True"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </EventTrigger>
                                            </TextBlock.Triggers>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- Input Area -->
        <Border Grid.Row="2" 
                Background="{StaticResource CardBrush}" 
                CornerRadius="12" 
                Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         AcceptsReturn="False"
                         MaxHeight="100">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding SendMessageCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="12,0,0,0">
                    <!-- Send Button -->
                    <Button Command="{Binding SendMessageCommand}"
                            IsEnabled="{Binding IsGenerating, Converter={StaticResource InverseBool}}"
                            Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}"
                            Style="{StaticResource PrimaryButton}"
                            Content="Send âž¤"/>
                    
                    <!-- Stop Button -->
                    <Button Command="{Binding StopGenerationCommand}"
                            Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVis}}"
                            Style="{StaticResource SecondaryButton}"
                            BorderBrush="{StaticResource ErrorBrush}"
                            Content="â¹ Stop"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Performance Stats -->
        <Border Grid.Row="3" 
                Background="{StaticResource SurfaceBrush}" 
                CornerRadius="8" 
                Padding="12"
                Margin="0,12,0,0">
            <StackPanel Orientation="Horizontal">
                <TextBlock Foreground="{StaticResource TextMutedBrush}" FontSize="12">
                    <Run Text="âš¡"/>
                    <Run Text="{Binding TokensPerSecond, StringFormat={}{0:F1}}"/>
                    <Run Text="tok/s"/>
                </TextBlock>
                <TextBlock Foreground="{StaticResource TextMutedBrush}" FontSize="12" Margin="20,0,0,0">
                    <Run Text="ðŸ“Š"/>
                    <Run Text="{Binding TotalTokens}"/>
                    <Run Text="tokens"/>
                </TextBlock>
                <TextBlock Foreground="{StaticResource TextMutedBrush}" FontSize="12" Margin="20,0,0,0">
                    <Run Text="ðŸ’¾"/>
                    <Run Text="{Binding MemoryUsage}"/>
                </TextBlock>
                <TextBlock Foreground="{StaticResource TextMutedBrush}" FontSize="12" Margin="20,0,0,0">
                    <Run Text="â±"/>
                    <Run Text="{Binding ElapsedTime}"/>
                </TextBlock>
            </StackPanel>
        </Border>
        </Grid>
    </Grid>
</UserControl>

